<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#121212">
    <meta name="msapplication-TileColor" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>Touche l'écran</title>
    <style>
        :root {
            --bg: #0b0d10;
            --fg: #c9d1d9;
            --hint: #7d8590;
            --touch: #3b82f6;
            --player-gray: #9ca3af;
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0;
            background: var(--bg);
            color: var(--fg);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            -webkit-user-select: none; user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
        }
        .stage {
            position: relative;
            width: 100vw; height: 100vh;
            touch-action: none;
            display: grid; place-items: center;
        }
        .hint {
            position: absolute; inset: 0;
            display: grid; place-items: center;
            pointer-events: none;
            font-size: clamp(18px, 4.5vw, 34px);
            letter-spacing: .5px;
            color: var(--hint);
            opacity: .9;
        }
        .bubble {
            position: absolute;
            width: 40px; height: 40px;
            transform: translate(-50%, -50%);
            border-radius: 999px;
            pointer-events: none;
            box-shadow: 0 4px 16px rgba(0,0,0,.35), inset 0 0 0 2px rgba(255,255,255,.12);
            transition: opacity .25s ease-out;
        }
        .bubble.fade {
            animation: fadeOut 1.2s ease-out forwards;
        }
        @keyframes fadeOut {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.6); }
        }
        .ripple {
            position: absolute;
            width: 12px; height: 12px;
            transform: translate(-50%, -50%);
            border-radius: 999px;
            pointer-events: none;
            box-shadow: 0 0 0 0 rgba(255,255,255,.2);
            animation: ripple .5s ease-out forwards;
        }
        #toolbar {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background: rgba(20, 20, 20, 0.85);
            padding: 8px 12px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            z-index: 1000;
        }
        #toolbar select, #toolbar input {
            background: #1e1e1e;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 4px 6px;
            font-size: 14px;
        }
        #toolbar input[type="color"] {
            padding: 0;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <select id="playerSelect">
            <option value="player01">Player 01</option>
            <option value="player02">Player 02</option>
            <option value="player03">Player 03</option>
            <option value="player04">Player 04</option>
            <option value="player05">Player 05</option>
        </select>
        <input type="color" id="colorPicker" value="#27F5D3">
    </div>

    <div id="stage" class="stage" aria-label="zone tactile">
        <div class="hint" id="hint">touche l'écran</div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let client_id = localStorage.getItem("userId") || generateId();
        localStorage.setItem("userId", client_id);

        function generateId() {
            return "client-" + Math.random().toString(36).substr(2, 9);
        }

        let settings = {
            color: '27F5D3', // Couleur par défaut
            player_id: 'player01' // Player par défaut
        }

        const stage = document.getElementById('stage');
        const hint = document.getElementById('hint');

        function normalizeToPercent(pageX, pageY) {
            const rect = stage.getBoundingClientRect();
            const relX = pageX - rect.left;
            const relY = pageY - rect.top;
            const w = rect.width, h = rect.height;
            const long = Math.max(w, h);
            const short = Math.min(w, h);
            const u = (w >= h) ? relX : relY;
            const v = (w >= h) ? relY : relX;
            const x = Math.max(0, Math.min(100, (u / long) * 100));
            const y = Math.max(0, Math.min(100, (v / short) * 100));
            return { x: +x.toFixed(2), y: +y.toFixed(2) };
        }

        function percentToPixels(x, y) {
            const rect = stage.getBoundingClientRect();
            const w = rect.width, h = rect.height;
            const long = Math.max(w, h);
            const short = Math.min(w, h);
            const u = (x / 100) * long;
            const v = (y / 100) * short;
            const relX = (w >= h) ? u : v;
            const relY = (w >= h) ? v : u;
            return { left: rect.left + relX, top: rect.top + relY };
        }

        function addBubble(px, py, color, fade = true) {
            const el = document.createElement('div');
            el.className = 'bubble' + (fade ? ' fade' : '');
            el.style.background = color;
            const rect = stage.getBoundingClientRect();
            el.style.left = (px - rect.left) + 'px';
            el.style.top  = (py - rect.top) + 'px';
            stage.appendChild(el);
            if (fade) setTimeout(() => el.remove(), 1300);
            return el;
        }

        function addRipple(px, py) {
            const el = document.createElement('div');
            el.className = 'ripple';
            const rect = stage.getBoundingClientRect();
            el.style.left = (px - rect.left) + 'px';
            el.style.top  = (py - rect.top) + 'px';
            stage.appendChild(el);
            setTimeout(() => el.remove(), 550);
        }

        function emitTouch(x, y, first = false, last = false) {
            if (!socket) return;
            socket.emit('client_action_trigger', {
                client_id: client_id,
                action: 'client_move',
                datas: { x, y, settings, first, last }
            });
        }

        if (socket) {
            socket.on('connect', () => {
                socket.emit('hello', { client_id: client_id, role: 'touchpad' });
            });
        }

        let isDown = false;
        let moveThrottle = 0;

        function handlePoint(pageX, pageY, first = false, last = false) {
            const { x, y } = normalizeToPercent(pageX, pageY);
            emitTouch(x, y, first, last);
            const { left, top } = percentToPixels(x, y);
            addRipple(left, top);
            addBubble(left, top, 'var(--touch)', true);
            hint.style.opacity = 0;
        }

        stage.addEventListener('touchstart', (e) => {
            isDown = true;
            for (const t of e.changedTouches) handlePoint(t.clientX, t.clientY, true, false);
        }, { passive: true });

        stage.addEventListener('touchmove', (e) => {
            const now = performance.now();
            if (now - moveThrottle > 40) {
                for (const t of e.touches) handlePoint(t.clientX, t.clientY, false, false);
                moveThrottle = now;
            }
        }, { passive: true });

        stage.addEventListener('touchend', () => { isDown = false; }, { passive: true });
        stage.addEventListener('touchcancel', () => { isDown = false; }, { passive: true });

        stage.addEventListener('mousedown', (e) => {
            isDown = true;
            handlePoint(e.clientX, e.clientY, true, false);
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            const now = performance.now();
            if (now - moveThrottle > 40) {
                handlePoint(e.clientX, e.clientY, false, false);
                moveThrottle = now;
            }
        });

        window.addEventListener('mouseup', () => { isDown = false; });

        window.addEventListener('contextmenu', (e) => e.preventDefault());
        window.addEventListener('gesturestart', (e) => e.preventDefault());

        const playerSelect = document.getElementById("playerSelect");
        const colorPicker = document.getElementById("colorPicker");

        playerSelect.addEventListener("change", () => {
            settings.player_id = playerSelect.value;
        });

        colorPicker.addEventListener("input", () => {
            settings.color = colorPicker.value.replace("#", "");
        });
    </script>
</body>
</html>
